# Preprocess data and train model
def model_and_df():
    df = dat()
    
    df['count_of_EV'] = df.groupby('Model Year')['Model Year'].transform('count')
    
    X = df[['Model Year']].values
    y = df['count_of_EV'].values
    
    model = LinearRegression()
    model.fit(X, y)
    
    return model, df

# Define reactive function for histogram data
@reactive.calc()
def ev_count_histogram(df, selected_year):
    filtered_df = df[df['Model Year'] <= selected_year]
    fig = px.histogram(filtered_df, x="Model Year", title="Electric Vehicle Count by Year")
    return fig

# Define reactive function for scatter plot data
@reactive.calc()
def ev_count_scatter(df, selected_year):
    filtered_df = df[df['Model Year'] <= selected_year]
    fig = px.scatter(filtered_df, x="Model Year", y="count_of_EV", title="Electric Vehicle Count Scatter Plot")
    return fig

# Define Shiny UI
def main():
    @reactive.calc()
    def get_selected_year():
        return ui.selected_year().get()

    with ui.page_auto():
        ui.sidebar()

        # Input slider for selecting the year range
        ui.input_slider("selected_year", "Select Year", 2012, 2030, 2025)

        with ui.card():
            render(ev_count_histogram(model_and_df()[1], get_selected_year))

        with ui.card():
            render(ev_count_scatter(model_and_df()[1], get_selected_year))

    # Set the default selected year
    ui.selected_year(2025)



#

# Plotly Histogram
with ui.navset_card_tab(id="tab"):
    with ui.nav_panel("EV Histogram"):
        @render_plotly
        def plotly_histogram(Select_Year, select_attribute_list):
            filtered_df = df[df['Make Year'] == Select_Year]
            
            # Create a title for the histogram
            title = f"EV Data for Year {Select_Year}"
            
            # Generate histogram using Plotly
            plotly_hist = px.histogram(
                data_frame=filtered_df,
                x=select_attribute_list[0],  # Using the first selected attribute
                color="count",
                title=title,
                labels={'count': 'Count'}
            )
            
            return plotly_hist
